<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>GO BURGER - Painel de Pedidos</title>
    <link rel="manifest" href="manifest-painel.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='20' fill='%23667eea'/%3E%3Ctext x='96' y='140' font-size='120' text-anchor='middle' fill='white'%3Eüìã%3C/text%3E%3C/svg%3E">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3Eüìã%3C/text%3E%3C/svg%3E">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Orders">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --gray: #6b7280;
            --light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--light);
            min-height: 100vh;
            color: var(--dark);
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header h1 {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: white;
            color: var(--primary);
        }
        
        .btn-primary:hover {
            background: var(--light);
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid currentColor;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            justify-content: center;
            border-radius: 50%;
        }
        
        /* Stats Bar */
        .stats-bar {
            background: white;
            padding: 15px 20px;
            display: flex;
            gap: 15px;
            overflow-x: auto;
            box-shadow: var(--shadow);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .stat-item:hover {
            transform: scale(1.05);
        }
        
        .stat-item.active {
            box-shadow: 0 0 0 2px var(--primary);
        }
        
        .stat-item.pending { background: #fef3c7; color: #92400e; }
        .stat-item.confirmed { background: #dbeafe; color: #1e40af; }
        .stat-item.preparing { background: #ede9fe; color: #5b21b6; }
        .stat-item.ready { background: #d1fae5; color: #065f46; }
        .stat-item.delivered { background: #e5e7eb; color: #374151; }
        .stat-item.all { background: var(--primary); color: white; }
        
        .stat-count {
            background: rgba(0,0,0,0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        /* Main Content */
        .main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Orders List */
        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .order-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .order-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .order-card.pending { border-left: 4px solid var(--warning); }
        .order-card.confirmed { border-left: 4px solid var(--info); }
        .order-card.preparing { border-left: 4px solid #8b5cf6; }
        .order-card.ready { border-left: 4px solid var(--success); }
        .order-card.delivered { border-left: 4px solid var(--gray); }
        
        .order-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid var(--light);
        }
        
        .order-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .order-number {
            background: var(--primary);
            color: white;
            padding: 2px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .order-meta {
            font-size: 13px;
            color: var(--gray);
            margin-top: 4px;
        }
        
        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-confirmed { background: #dbeafe; color: #1e40af; }
        .status-preparing { background: #ede9fe; color: #5b21b6; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-delivered { background: #e5e7eb; color: #374151; }
        
        .order-body {
            padding: 15px;
        }
        
        .order-customer {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .customer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .customer-info h4 {
            font-size: 14px;
            font-weight: 600;
        }
        
        .customer-info p {
            font-size: 12px;
            color: var(--gray);
        }
        
        .order-items {
            background: var(--light);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 12px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 13px;
        }
        
        .order-item:not(:last-child) {
            border-bottom: 1px dashed #ddd;
        }
        
        .item-qty {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-right: 8px;
        }
        
        .order-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            padding-top: 10px;
            border-top: 2px solid var(--light);
        }
        
        .total-value {
            font-size: 1.2rem;
            color: var(--success);
        }
        
        .order-actions {
            padding: 15px;
            background: var(--light);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .order-actions .btn {
            flex: 1;
            min-width: 100px;
            justify-content: center;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }
        
        .modal-header h2 {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--light);
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--light);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            position: sticky;
            bottom: 0;
            background: white;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        select.form-control {
            cursor: pointer;
        }
        
        /* Products Selector */
        .products-section {
            margin-top: 20px;
        }
        
        .products-search {
            position: relative;
            margin-bottom: 15px;
        }
        
        .products-search input {
            padding-left: 40px;
        }
        
        .products-search i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            max-height: 450px;
            overflow-y: auto;
            padding: 10px;
            background: var(--light);
            border-radius: 8px;
        }
        
        .product-item {
            background: white;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .product-item:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }
        
        .product-item.selected {
            border-color: var(--success);
            background: #d1fae5;
        }
        
        .product-item .name {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .product-item .price {
            font-size: 14px;
            font-weight: 600;
            color: var(--success);
        }
        
        .product-category-header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.3);
        }
        
        .product-category-header:first-child {
            margin-top: 0;
        }
        
        .product-category-header i {
            font-size: 20px;
        }
        
        /* Cart Items */
        .cart-items {
            margin-top: 20px;
        }
        
        .cart-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-info .name {
            font-weight: 500;
            font-size: 14px;
        }
        
        .cart-item-info .price {
            font-size: 12px;
            color: var(--gray);
        }
        
        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .qty-btn {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        .qty-btn:hover {
            background: var(--primary-dark);
        }
        
        .qty-value {
            font-weight: 600;
            min-width: 30px;
            text-align: center;
        }
        
        .cart-item-remove {
            color: var(--danger);
            cursor: pointer;
            padding: 5px;
        }
        
        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--dark);
            color: white;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .cart-total .label {
            font-size: 14px;
        }
        
        .cart-total .value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUp 0.3s ease;
            box-shadow: var(--shadow-lg);
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }
        
        /* FAB - Floating Action Button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--success);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            transition: all 0.2s;
        }
        
        .fab:hover {
            transform: scale(1.1);
            background: #059669;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            .header h1 span {
                display: none;
            }
            
            .stats-bar {
                padding: 10px 15px;
            }
            
            .stat-item {
                padding: 6px 12px;
                font-size: 12px;
            }
            
            .main {
                padding: 15px;
            }
            
            .order-actions {
                flex-direction: column;
            }
            
            .order-actions .btn {
                min-width: auto;
            }
            
            .modal-content {
                max-height: 100vh;
                border-radius: 0;
            }
            
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Connection Status */
        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        /* Ingredient Item */
        .ingredient-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        
        .ingredient-item:hover {
            background: #e8eaf6;
        }
        
        .ingredient-item.selected {
            background: #e3f2fd;
            border-color: var(--primary);
        }
        
        .ingredient-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
        }
        
        .ingredient-item label {
            flex: 1;
            cursor: pointer;
            margin: 0;
            font-weight: 500;
        }
        
        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .connection-dot.online { background: var(--success); }
        .connection-dot.offline { background: var(--danger); }
        
        /* Date Filter Bar */
        .date-filter-bar {
            background: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }
        
        .date-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .date-filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--light);
            border-radius: 8px;
            background: white;
            color: var(--gray);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .date-filter-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .date-filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .custom-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 2px solid var(--light);
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
        }
        
        .date-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        
        .date-separator {
            color: var(--gray);
            margin: 0 5px;
        }
        
        .loading-text {
            margin-top: 15px;
            color: var(--gray);
        }
        
        .modal-notes {
            margin-top: 20px;
        }
        
        #address-group,
        #table-group,
        #cart-total {
            display: none;
        }
        
        #status-modal .modal-content {
            max-width: 400px;
        }
        
        #customize-modal .modal-content {
            max-width: 500px;
        }
        
        .status-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .status-actions .btn {
            justify-content: flex-start;
        }
        
        .status-actions hr {
            margin: 10px 0;
            border: none;
            border-top: 1px solid #ddd;
        }
        
        .btn-preparing {
            background: #8b5cf6;
            color: white;
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        #ingredients-list {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1>
                <i class="fas fa-clipboard-list"></i>
                <span>Painel de Pedidos</span>
            </h1>
            <div class="header-actions">
                <span id="connection-status">
                    <span class="connection-dot offline"></span>
                </span>
                <button class="btn btn-primary btn-sm" onclick="forceReload()" title="Limpar Cache">
                    <i class="fas fa-broom"></i>
                </button>
                <button class="btn btn-warning btn-sm" onclick="testNotification()" title="Testar Notifica√ß√£o">
                    <i class="fas fa-bell"></i>
                </button>
                <button class="btn btn-primary btn-sm" onclick="refreshOrders()" title="Atualizar">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="btn btn-primary btn-sm hidden" id="logout-btn" onclick="doLogout()" title="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item all active" data-filter="all" onclick="filterOrders('all')">
            <i class="fas fa-list"></i>
            Todos
            <span class="stat-count" id="count-all">0</span>
        </div>
        <div class="stat-item pending" data-filter="pending" onclick="filterOrders('pending')">
            <i class="fas fa-clock"></i>
            Pendentes
            <span class="stat-count" id="count-pending">0</span>
        </div>
        <div class="stat-item confirmed" data-filter="confirmed" onclick="filterOrders('confirmed')">
            <i class="fas fa-check"></i>
            Confirmados
            <span class="stat-count" id="count-confirmed">0</span>
        </div>
        <div class="stat-item preparing" data-filter="preparing" onclick="filterOrders('preparing')">
            <i class="fas fa-fire"></i>
            Preparando
            <span class="stat-count" id="count-preparing">0</span>
        </div>
        <div class="stat-item ready" data-filter="ready" onclick="filterOrders('ready')">
            <i class="fas fa-bell"></i>
            Prontos
            <span class="stat-count" id="count-ready">0</span>
        </div>
        <div class="stat-item delivered" data-filter="delivered" onclick="filterOrders('delivered')">
            <i class="fas fa-check-double"></i>
            Entregues
            <span class="stat-count" id="count-delivered">0</span>
        </div>
    </div>
    
    <!-- Date Filter Bar -->
    <div class="date-filter-bar">
        <div class="date-filters">
            <button class="date-filter-btn active" data-period="today" onclick="filterByDate('today')">
                <i class="fas fa-calendar-day"></i> Hoje
            </button>
            <button class="date-filter-btn" data-period="yesterday" onclick="filterByDate('yesterday')">
                <i class="fas fa-calendar-minus"></i> Ontem
            </button>
            <button class="date-filter-btn" data-period="week" onclick="filterByDate('week')">
                <i class="fas fa-calendar-week"></i> 7 dias
            </button>
            <button class="date-filter-btn" data-period="month" onclick="filterByDate('month')">
                <i class="fas fa-calendar"></i> 30 dias
            </button>
            <button class="date-filter-btn" data-period="all" onclick="filterByDate('all')">
                <i class="fas fa-infinity"></i> Todos
            </button>
        </div>
        <div class="custom-date">
            <input type="date" id="date-from" class="date-input" onchange="filterByCustomDate()" title="Data inicial" aria-label="Data inicial">
            <span class="date-separator">at√©</span>
            <input type="date" id="date-to" class="date-input" onchange="filterByCustomDate()" title="Data final" aria-label="Data final">
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="main">
        <div class="orders-list" id="orders-list">
            <div class="loading">
                <div class="spinner"></div>
                <p class="loading-text">Carregando pedidos...</p>
            </div>
        </div>
    </main>
    
    <!-- FAB - New Order -->
    <button class="fab" onclick="openNewOrderModal()" title="Novo Pedido">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Modal: New/Edit Order -->
    <div class="modal" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-receipt"></i>
                    <span id="modal-title">Novo Pedido</span>
                </h2>
                <button class="modal-close" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="order-form">
                    <input type="hidden" id="order-id">
                    
                    <div class="form-group">
                        <label>Cliente</label>
                        <input type="text" class="form-control" id="customer-name" placeholder="Nome do cliente" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" class="form-control" id="customer-phone" placeholder="(00) 00000-0000">
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo de Pedido</label>
                        <select class="form-control" id="order-type">
                            <option value="balcao">Balcao</option>
                            <option value="delivery">Delivery</option>
                            <option value="mesa">Mesa</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="address-group">
                        <label>Endereco de Entrega</label>
                        <textarea class="form-control" id="delivery-address" rows="2" placeholder="Rua, numero, bairro..."></textarea>
                    </div>
                    
                    <div class="form-group" id="table-group">
                        <label>Numero da Mesa</label>
                        <input type="number" class="form-control" id="table-number" placeholder="Ex: 5">
                    </div>
                    
                    <!-- Products Section -->
                    <div class="products-section">
                        <label>Produtos</label>
                        <div class="products-search">
                            <i class="fas fa-search"></i>
                            <input type="text" class="form-control" id="product-search" placeholder="Buscar produto...">
                        </div>
                        <div class="products-grid" id="products-grid">
                            <!-- Products loaded here -->
                        </div>
                    </div>
                    
                    <!-- Cart Items -->
                    <div class="cart-items" id="cart-items">
                        <!-- Cart items here -->
                    </div>
                    
                    <div class="cart-total" id="cart-total">
                        <span class="label">Total do Pedido</span>
                        <span class="value" id="total-value">R$ 0,00</span>
                    </div>
                    
                    <div class="form-group modal-notes">
                        <label>Observa√ß√µes</label>
                        <textarea class="form-control" id="order-notes" rows="2" placeholder="Observa√ß√µes do pedido..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-success" onclick="saveOrder()">
                    <i class="fas fa-save"></i>
                    Salvar Pedido
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal: Change Status -->
    <div class="modal" id="status-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-exchange-alt"></i>
                    Alterar Status
                </h2>
                <button class="modal-close" onclick="closeStatusModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="status-order-id">
                <div class="status-actions">
                    <button class="btn btn-warning" onclick="setStatus('pending')">
                        <i class="fas fa-clock"></i> Pendente
                    </button>
                    <button class="btn btn-info" onclick="setStatus('confirmed')">
                        <i class="fas fa-check"></i> Confirmado
                    </button>
                    <button class="btn btn-preparing" onclick="setStatus('preparing')">
                        <i class="fas fa-fire"></i> Preparando
                    </button>
                    <button class="btn btn-success" onclick="setStatus('ready')">
                        <i class="fas fa-bell"></i> Pronto
                    </button>
                    <button class="btn btn-secondary" onclick="setStatus('delivered')">
                        <i class="fas fa-check-double"></i> Entregue
                    </button>
                    <button class="btn btn-danger" onclick="setStatus('cancelled')">
                        <i class="fas fa-times"></i> Cancelado
                    </button>
                    <hr>
                    <button class="btn btn-danger btn-outline" onclick="deleteOrderFromModal()">
                        <i class="fas fa-trash"></i> Excluir Pedido
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Customize Product -->
    <div class="modal" id="customize-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-burger"></i>
                    <span id="customize-product-name">Monte seu Burger</span>
                </h2>
                <button class="modal-close" onclick="closeCustomizeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="customize-product-id">
                
                <!-- Customiza√ß√µes Din√¢micas (Ponto da Carne, Adicionais, etc) -->
                <div id="customizations-container" style="display: none; margin-bottom: 20px;">
                    <!-- Populated dynamically from database -->
                </div>
                
                <!-- Fallback: Lista simples de ingredientes -->
                <div id="simple-ingredients-container" class="form-group">
                    <label>Selecione os Ingredientes:</label>
                    <div id="ingredients-list">
                        <!-- Ingredientes serao carregados aqui -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Observa√ß√µes:</label>
                    <textarea id="customize-notes" class="form-control" rows="2" placeholder="Ex: Sem cebola, bem passado..."></textarea>
                </div>
                
                <!-- Resumo de Customiza√ß√£o e Pre√ßo -->
                <div id="customization-summary" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid var(--primary);">
                    <strong style="display: block; margin-bottom: 10px;">üìã Resumo:</strong>
                    <div id="summary-content"></div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #dee2e6; font-size: 1.1em;">
                        <strong>Pre√ßo Total:</strong> <span id="custom-total-price" style="color: var(--success); font-weight: 700;">R$ 0,00</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCustomizeModal()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="addCustomizedToCart()">
                    <i class="fas fa-cart-plus"></i>
                    Adicionar ao Pedido
                </button>
            </div>
        </div>
    </div>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // ========================================
        // REGISTRAR SERVICE WORKER + NOTIFICA√á√ïES PWA
        // ========================================
        if ('serviceWorker' in navigator) {
            // Desregistrar service workers antigos
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                registrations.forEach(function(registration) {
                    if (!registration.active || !registration.active.scriptURL.includes('sw-painel.js')) {
                        registration.unregister();
                        console.log('SW antigo desregistrado');
                    }
                });
            });
            
            // Registrar novo Service Worker para PWA
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw-painel.js', { scope: '/' })
                    .then(function(registration) {
                        console.log('‚úÖ Service Worker PWA registrado!', registration.scope);
                        
                        // Solicitar permiss√£o para notifica√ß√µes
                        if ('Notification' in window && Notification.permission === 'default') {
                            setTimeout(function() {
                                Notification.requestPermission().then(function(permission) {
                                    if (permission === 'granted') {
                                        console.log('‚úÖ Notifica√ß√µes ativadas!');
                                        showToast('Notifica√ß√µes ativadas! üîî', 'success');
                                    }
                                });
                            }, 3000);
                        }
                    })
                    .catch(function(error) {
                        // Silenciar erro quando aberto via file:// (normal em desenvolvimento local)
                        if (!error.message.includes('not supported')) {
                            console.error('‚ùå Erro ao registrar SW:', error);
                        }
                    });
            });
            
            // Escutar mensagens do Service Worker
            navigator.serviceWorker.addEventListener('message', function(event) {
                if (event.data.type === 'SYNC_ORDERS') {
                    refreshOrders();
                }
            });
        }
        
        // Bot√£o de instala√ß√£o do PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            e.preventDefault();
            deferredPrompt = e;
            showInstallPrompt();
        });
        
        function showInstallPrompt() {
            const installBtn = document.createElement('button');
            installBtn.className = 'btn btn-success';
            installBtn.style.cssText = 'position:fixed;top:70px;right:20px;z-index:999;box-shadow:0 4px 12px rgba(0,0,0,0.3);';
            installBtn.innerHTML = '<i class="fas fa-download"></i> Instalar App';
            installBtn.onclick = function() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(function(choiceResult) {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('‚úÖ App instalado!');
                            showToast('App instalado com sucesso! üéâ', 'success');
                        }
                        deferredPrompt = null;
                        installBtn.remove();
                    });
                }
            };
            document.body.appendChild(installBtn);
            setTimeout(function() { if (installBtn.parentNode) installBtn.remove(); }, 10000);
        }
        
        // Fun√ß√£o para enviar notifica√ß√£o de novo pedido (H√çBRIDA)
        function notifyNewOrder(order) {
            console.log('üì¢ notifyNewOrder chamada para:', order.id);
            
            var orderData = {
                id: order.id,
                number: order.numero || order.number || order.id.slice(-4),
                customerName: (order.cliente && order.cliente.nome) || order.customerName || 'Cliente',
                total: (order.valores && order.valores.total) || order.total || 0
            };
            
            // Tentar via Service Worker primeiro (para PWA instalado)
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                console.log('üì§ Enviando via Service Worker');
                navigator.serviceWorker.controller.postMessage({
                    type: 'NEW_ORDER',
                    order: orderData
                });
            }
            
            // Notifica√ß√£o direta (funciona sempre que tiver permiss√£o)
            if ('Notification' in window && Notification.permission === 'granted') {
                console.log('üîî Criando notifica√ß√£o direta');
                
                try {
                    var notification = new Notification('üçî Novo Pedido #' + orderData.number, {
                        body: orderData.customerName + ' - R$ ' + orderData.total.toFixed(2) + '\nClique para ver detalhes',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üìã</text></svg>',
                        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üçî</text></svg>',
                        tag: 'order-' + orderData.id,
                        vibrate: [200, 100, 200, 100, 200],
                        requireInteraction: true,
                        silent: false
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                    
                    console.log('‚úÖ Notifica√ß√£o criada com sucesso!');
                } catch (error) {
                    console.error('‚ùå Erro ao criar notifica√ß√£o:', error);
                }
            } else {
                console.warn('‚ö†Ô∏è Sem permiss√£o para notifica√ß√µes. Status:', Notification.permission);
            }
        }
        
        // Fun√ß√£o para notificar pedido pronto (H√çBRIDA)
        function notifyOrderReady(order) {
            console.log('üì¢ notifyOrderReady chamada para:', order.id);
            
            var orderData = {
                id: order.id,
                number: order.numero || order.number || order.id.slice(-4),
                customerName: (order.cliente && order.cliente.nome) || order.customerName || 'Cliente'
            };
            
            // Tentar via Service Worker
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'ORDER_READY',
                    order: orderData
                });
            }
            
            // Notifica√ß√£o direta
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    var notification = new Notification('‚úÖ Pedido Pronto! #' + orderData.number, {
                        body: orderData.customerName + ' - Pedido est√° pronto para retirada/entrega!',
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">‚úÖ</text></svg>',
                        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üçî</text></svg>',
                        tag: 'ready-' + orderData.id,
                        vibrate: [300, 100, 300],
                        requireInteraction: true
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        notification.close();
                    };
                } catch (error) {
                    console.error('‚ùå Erro ao notificar pedido pronto:', error);
                }
            }
        }
        
        // Testar notifica√ß√£o manualmente
        function testNotification() {
            console.log('üß™ Testando notifica√ß√£o...');
            console.log('üìä Status atual:', {
                suporte: 'Notification' in window,
                permissao: Notification.permission,
                serviceWorker: 'serviceWorker' in navigator,
                controller: navigator.serviceWorker && navigator.serviceWorker.controller ? 'Sim' : 'N√£o'
            });
            
            if (!('Notification' in window)) {
                alert('‚ùå Seu navegador n√£o suporta notifica√ß√µes');
                return;
            }
            
            if (Notification.permission === 'denied') {
                alert('‚ùå Notifica√ß√µes bloqueadas!\n\nPara ativar:\n1. Clique no cadeado/√≠cone ao lado da URL\n2. Permiss√µes ‚Üí Notifica√ß√µes\n3. Escolha "Permitir"\n4. Recarregue a p√°gina');
                return;
            }
            
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(function(permission) {
                    console.log('üîî Nova permiss√£o:', permission);
                    if (permission === 'granted') {
                        setTimeout(testNotification, 500); // Tentar novamente
                    } else {
                        alert('‚ö†Ô∏è Voc√™ negou a permiss√£o de notifica√ß√µes');
                    }
                });
                return;
            }
            
            // Criar notifica√ß√£o de teste
            try {
                var notification = new Notification('üß™ Teste de Notifica√ß√£o GO BURGER', {
                    body: 'Se voc√™ viu isso, as notifica√ß√µes est√£o FUNCIONANDO! üéâ\n\nVoc√™ receber√° alertas de novos pedidos.',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üîî</text></svg>',
                    badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">üçî</text></svg>',
                    vibrate: [200, 100, 200, 100, 200],
                    requireInteraction: false,
                    silent: false
                });
                
                notification.onclick = function() {
                    window.focus();
                    showToast('‚úÖ Notifica√ß√µes est√£o ATIVAS!', 'success');
                    notification.close();
                };
                
                console.log('‚úÖ Notifica√ß√£o de teste enviada!');
                showToast('üîî Verifique se apareceu a notifica√ß√£o!', 'info');
            } catch (error) {
                console.error('‚ùå Erro ao criar notifica√ß√£o de teste:', error);
                alert('‚ùå Erro: ' + error.message);
            }
        }
        
        // ========================================
        // CONFIGURACAO
        // ========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBqJQd0YpxjndeUDLoBIDjw7WPpE42YI6s",
            authDomain: "burgerpdv.firebaseapp.com",
            databaseURL: "https://burgerpdv-default-rtdb.firebaseio.com",
            projectId: "burgerpdv",
            storageBucket: "burgerpdv.firebasestorage.app",
            messagingSenderId: "810043325830",
            appId: "1:810043325830:web:fcbdb9de2c6330633c4007"
        };
        
        // Inicializar Firebase
        let database = null;
        let auth = null;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            auth = firebase.auth();
            console.log('Firebase inicializado');
        } catch (error) {
            console.error('Erro Firebase:', error);
        }
        
        // ========================================
        // ESTADO
        // ========================================
        
        let allOrders = [];
        let allProducts = [];
        let currentFilter = 'all';
        let dateFilter = 'today'; // Filtro padr√£o: HOJE
        let customDateFrom = null;
        let customDateTo = null;
        let cartItems = [];
        let editingOrderId = null;
        let messageTemplates = {};
        
        // ========================================
        // INICIALIZACAO
        // ========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticacao
            if (auth) {
                auth.onAuthStateChanged(function(user) {
                    if (user) {
                        console.log('Usuario:', user.email);
                        updateConnectionStatus(true);
                        document.getElementById('logout-btn').classList.remove('hidden');
                        loadData();
                    } else {
                        showLoginRequired();
                    }
                });
            }
            
            // Event listeners
            document.getElementById('order-type').addEventListener('change', handleOrderTypeChange);
            document.getElementById('product-search').addEventListener('input', filterProducts);
        });
        
        function showLoginRequired() {
            console.log('Usuario nao autenticado - mostrando tela de login');
            document.getElementById('orders-list').innerHTML = 
                '<div class="empty-state">' +
                '<i class="fas fa-lock"></i>' +
                '<h3>Acesso ao Painel</h3>' +
                '<form onsubmit="doLogin(event)" style="max-width: 300px; margin: 20px auto;">' +
                    '<div style="margin-bottom: 15px;">' +
                        '<input type="email" id="login-email" class="form-control" placeholder="Email" required>' +
                    '</div>' +
                    '<div style="margin-bottom: 15px;">' +
                        '<input type="password" id="login-password" class="form-control" placeholder="Senha" required>' +
                    '</div>' +
                    '<button type="submit" class="btn btn-primary" style="width: 100%;">' +
                        '<i class="fas fa-sign-in-alt"></i> Entrar' +
                    '</button>' +
                '</form>' +
                '</div>';
            updateConnectionStatus(false);
        }
        
        async function doLogin(event) {
            event.preventDefault();
            var email = document.getElementById('login-email').value;
            var password = document.getElementById('login-password').value;
            
            try {
                showToast('Entrando...', 'info');
                await auth.signInWithEmailAndPassword(email, password);
                showToast('Login realizado!', 'success');
            } catch (error) {
                console.error('Erro login:', error);
                showToast('Erro: ' + error.message, 'error');
            }
        }
        
        async function doLogout() {
            if (!confirm('Deseja sair?')) return;
            try {
                await auth.signOut();
                showToast('Saiu com sucesso', 'info');
                location.reload();
            } catch (error) {
                console.error('Erro logout:', error);
                showToast('Erro ao sair', 'error');
            }
        }
        
        async function loadMessageTemplates() {
            try {
                const templatesSnapshot = await database.ref('config/whatsapp-templates').once('value');
                const templates = templatesSnapshot.val();
                
                if (templates) {
                    messageTemplates = templates;
                    console.log('Templates de mensagem carregados:', messageTemplates);
                } else {
                    // Templates padr√£o se n√£o existir no Firebase
                    messageTemplates = {
                        confirmed: 'Ol√° {nome}! Seu pedido #{numero} foi CONFIRMADO e j√° est√° sendo preparado! üçî',
                        preparing: '{nome}, seu pedido #{numero} est√° sendo PREPARADO com todo carinho! üë®‚Äçüç≥',
                        ready: 'üéâ {nome}! Seu pedido #{numero} est√° PRONTO! Aguardamos voc√™ para retirar.',
                        delivered: 'Obrigado {nome}! Esperamos que tenha gostado do seu pedido #{numero}. Volte sempre! ‚ù§Ô∏è'
                    };
                    console.log('Usando templates padr√£o (Firebase n√£o configurado)');
                }
            } catch (error) {
                // Silenciar erro de permiss√£o - usar templates padr√£o
                if (!error.message.includes('permission_denied')) {
                    console.warn('‚ö†Ô∏è Erro ao carregar templates:', error.message);
                }
                messageTemplates = {
                    confirmed: 'Ol√° {nome}! Seu pedido #{numero} foi CONFIRMADO e j√° est√° sendo preparado! üçî',
                    preparing: '{nome}, seu pedido #{numero} est√° sendo PREPARADO com todo carinho! üë®‚Äçüç≥',
                    ready: 'üéâ {nome}! Seu pedido #{numero} est√° PRONTO! Aguardamos voc√™ para retirar.',
                    delivered: 'Obrigado {nome}! Esperamos que tenha gostado do seu pedido #{numero}. Volte sempre! ‚ù§Ô∏è'
                };
            }
        }
        
        async function loadData() {
            try {
                // Carregar templates de mensagem
                await loadMessageTemplates();
                
                // Listener para pedidos em tempo real
                var previousOrdersCount = 0;
                var isFirstLoad = true;
                
                database.ref('online-orders').on('value', function(snapshot) {
                    const data = snapshot.val();
                    
                    if (data) {
                        // Filtrar pedidos deletados e mapear
                        var newOrders = [];
                        var pedidosIgnorados = { deletados: 0, semDados: 0, invalidos: 0 };
                        var pedidoExemplo = null;
                        
                        Object.entries(data).forEach(function(entry) {
                            var pedido = entry[1];
                            pedido.id = entry[0];
                            
                            // FILTRAR DELETADOS - N√£o mostrar pedidos deletados
                            if (pedido.deletedAt === true || pedido.deletedAt) {
                                pedidosIgnorados.deletados++;
                                return;
                            }
                            
                            // VALIDAR SE TEM DADOS MINIMOS (deve ter cliente OU itens)
                            var temCliente = pedido.cliente || pedido.customer || pedido.customerName;
                            var temItens = (pedido.items && pedido.items.length > 0) || (pedido.itens && pedido.itens.length > 0);
                            
                            if (!temCliente && !temItens) {
                                pedidosIgnorados.semDados++;
                                console.warn('‚ö†Ô∏è PEDIDO IGNORADO - Sem dados m√≠nimos:', {
                                    id: pedido.id,
                                    temCliente: temCliente,
                                    temItens: temItens,
                                    cliente: pedido.cliente || pedido.customer || pedido.customerName,
                                    items: pedido.items || pedido.itens,
                                    total: pedido.total || pedido.value || pedido.valores?.total
                                });
                                return;
                            }
                            
                            // Se n√£o tem itens, mas tem valores, pode ser pedido v√°lido
                            if (!temItens && pedido.valores && pedido.valores.total > 0) {
                                console.warn('‚ö†Ô∏è Pedido sem itens mas com total:', pedido.id, 'Total:', pedido.valores.total);
                                // N√£o retornar, deixar passar
                            }
                            
                            // Validar timestamp
                            if (!pedido.timestamp && !pedido.createdAt && !pedido.data) {
                                console.warn('‚ö†Ô∏è Pedido sem timestamp:', pedido.id);
                                pedido.timestamp = new Date().toISOString(); // Adicionar timestamp atual
                            }
                            
                            // Mapear status portugu√™s para ingl√™s
                            if (pedido.status === 'pendente') pedido.status = 'pending';
                            if (pedido.status === 'confirmado') pedido.status = 'confirmed';
                            if (pedido.status === 'preparando') pedido.status = 'preparing';
                            if (pedido.status === 'pronto') pedido.status = 'ready';
                            if (pedido.status === 'entregue') pedido.status = 'delivered';
                            if (pedido.status === 'cancelado') pedido.status = 'cancelled';
                            
                            // Salvar exemplo de pedido v√°lido
                            if (!pedidoExemplo && (pedido.items || pedido.itens)) {
                                pedidoExemplo = pedido;
                            }
                            
                            newOrders.push(pedido);
                        });
                        
                        // DETECTAR NOVOS PEDIDOS E NOTIFICAR
                        if (!isFirstLoad && newOrders.length > previousOrdersCount) {
                            // Encontrar pedidos novos comparando com lista anterior
                            var newOrdersToNotify = newOrders.filter(function(newOrder) {
                                return !allOrders.some(function(oldOrder) {
                                    return oldOrder.id === newOrder.id;
                                });
                            });
                            
                            // Notificar cada pedido novo
                            newOrdersToNotify.forEach(function(order) {
                                if (order.status === 'pending' || order.status === 'confirmed') {
                                    console.log('üîî NOVO PEDIDO DETECTADO:', order.id);
                                    notifyNewOrder(order);
                                    
                                    // Toast visual tamb√©m
                                    var customerName = (order.cliente && order.cliente.nome) || order.customerName || 'Cliente';
                                    var orderNum = order.numero || order.number || order.id.slice(-4);
                                    showToast('üçî Novo Pedido #' + orderNum + ' - ' + customerName, 'success');
                                }
                            });
                        }
                        
                        allOrders = newOrders;
                        previousOrdersCount = newOrders.length;
                        isFirstLoad = false;
                        
                        // Relat√≥rio de carregamento detalhado
                        console.log('‚úÖ Pedidos Carregados:', {
                            total: allOrders.length,
                            deletados: pedidosIgnorados.deletados,
                            semDados: pedidosIgnorados.semDados,
                            invalidos: pedidosIgnorados.invalidos
                        });
                        
                        if (pedidosIgnorados.deletados > 0) {
                            console.warn(`‚ö†Ô∏è ${pedidosIgnorados.deletados} pedidos foram deletados`);
                        }
                        if (pedidosIgnorados.semDados > 0) {
                            console.warn(`‚ö†Ô∏è ${pedidosIgnorados.semDados} pedidos n√£o t√™m cliente ou itens`);
                        }
                        if (pedidosIgnorados.invalidos > 0) {
                            console.warn(`‚ö†Ô∏è ${pedidosIgnorados.invalidos} pedidos inv√°lidos`);
                        }
                        
                        // Ordenar por data (mais recentes primeiro)
                        allOrders.sort(function(a, b) {
                            var dateA = new Date(a.timestamp || a.createdAt || a.data || 0);
                            var dateB = new Date(b.timestamp || b.createdAt || b.data || 0);
                            return dateB - dateA;
                        });
                    } else {
                        console.log('Nenhum pedido no banco');
                        allOrders = [];
                    }
                    
                    // Extrair produtos unicos dos pedidos para usar no cadastro manual
                    extractProductsFromOrders();
                    
                    updateStats();
                    renderOrders();
                }, function(error) {
                    console.error('Erro ao carregar pedidos online:', error);
                    showToast('Erro ao carregar pedidos: ' + error.message, 'error');
                });
                
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showToast('Erro ao carregar dados: ' + error.message, 'error');
            }
        }
        
        // Extrair produtos dos pedidos existentes
        function extractProductsFromOrders() {
            var productMap = {};
            var adicionaisUnicos = new Set();
            
            console.log('Extraindo produtos dos pedidos...');
            
            allOrders.forEach(function(order, orderIndex) {
                var items = order.itens || order.items || [];
                
                items.forEach(function(item, itemIndex) {
                    var productName = item.nome || item.name || item.titulo || 'Produto';
                    
                    // Se for "Monte seu Burger", extrair os adicionais/ingredientes
                    if (productName.toLowerCase().includes('monte') && productName.toLowerCase().includes('burger')) {
                        // Tentar m√∫ltiplos campos poss√≠veis para adicionais
                        var possiveisAdicionais = item.adicionais || item.customizacoes || item.extras || 
                                                 item.opcoes || item.complementos || item.ingredients || [];
                        
                        // CONVERTER STRING PARA ARRAY SE NECESS√ÅRIO
                        if (typeof possiveisAdicionais === 'string' && possiveisAdicionais.length > 0) {
                            // Tentar split por v√≠rgula, ou por + ou quebra de linha
                            possiveisAdicionais = possiveisAdicionais.split(/[,+\n]/).map(function(s) { 
                                return s.trim(); 
                            }).filter(function(s) { 
                                return s.length > 0; 
                            });
                        }
                        
                        if (Array.isArray(possiveisAdicionais) && possiveisAdicionais.length > 0) {
                            possiveisAdicionais.forEach(function(add) {
                                if (typeof add === 'string') {
                                    adicionaisUnicos.add(add);
                                } else if (add && (add.nome || add.name)) {
                                    var nomeAdicional = add.nome || add.name;
                                    adicionaisUnicos.add(nomeAdicional);
                                }
                            });
                        }
                        
                        // Configurar produto personalizado com preco zero
                        if (!productMap[productName]) {
                            productMap[productName] = {
                                id: productName,
                                name: productName,
                                nome: productName,
                                price: 0,
                                preco: 0,
                                customizable: true,
                                adicionais: []
                            };
                        }
                    } else {
                        // Produtos normais
                        var basePrice = item.preco || item.precoUnitario || item.price || item.valor || 0;
                        
                        if (!productMap[productName]) {
                            productMap[productName] = {
                                id: productName,
                                name: productName,
                                nome: productName,
                                price: basePrice,
                                preco: basePrice,
                                customizable: false,
                                adicionais: []
                            };
                        } else {
                            // Atualizar preco se encontrar um menor
                            if (basePrice > 0 && basePrice < productMap[productName].price) {
                                productMap[productName].price = basePrice;
                                productMap[productName].preco = basePrice;
                            }
                        }
                    }
                });
            });
            
            // Adicionar adicionais ao produto customizavel
            var adicionaisList = Array.from(adicionaisUnicos);
            Object.keys(productMap).forEach(function(key) {
                if (productMap[key].customizable) {
                    productMap[key].adicionais = adicionaisList;
                }
            });
            
            allProducts = Object.values(productMap);
            console.log('‚úÖ Produtos extra√≠dos:', allProducts.length, '| Adicionais √∫nicos:', adicionaisList.length);
            renderProducts();
        }
        
        // ========================================
        // RENDERIZACAO
        // ========================================
        
        function renderOrders() {
            var container = document.getElementById('orders-list');
            
            // Filtrar por status
            var filtered = allOrders;
            if (currentFilter !== 'all') {
                filtered = allOrders.filter(function(o) { 
                    return o.status === currentFilter; 
                });
            }
            
            // Remover pedidos cancelados do filtro "todos"
            if (currentFilter === 'all') {
                filtered = filtered.filter(function(o) {
                    return o.status !== 'cancelled';
                });
            }
            
            // Filtrar por data
            var beforeDateFilter = filtered.length;
            filtered = filterByDateRange(filtered);
            console.log('üìã Renderizando:', filtered.length, 'de', allOrders.length, 'pedidos | Filtro:', dateFilter);
            
            if (filtered.length === 0 && beforeDateFilter > 0) {
                console.warn('‚ö†Ô∏è Filtro de data removeu todos os pedidos. Ajuste o per√≠odo.');
            }
            
            // Ordenar por data (mais recente primeiro)
            filtered.sort(function(a, b) {
                var dateA = new Date(a.timestamp || a.createdAt || a.date || 0);
                var dateB = new Date(b.timestamp || b.createdAt || b.date || 0);
                return dateB - dateA; // Decrescente (mais novo no topo)
            });
            
            if (filtered.length === 0) {
                container.innerHTML = 
                    '<div class="empty-state">' +
                    '<i class="fas fa-inbox"></i>' +
                    '<h3>Nenhum pedido encontrado</h3>' +
                    '<p>Nenhum pedido corresponde aos filtros selecionados</p>' +
                    '</div>';
                return;
            }
            
            var html = '';
            filtered.forEach(function(order, index) {
                try {
                    html += createOrderCard(order);
                } catch (error) {
                    console.error('Erro ao criar card do pedido', index, error);
                }
            });
            
            container.innerHTML = html;
        }
        
        function filterByDateRange(orders) {
            if (dateFilter === 'all') {
                return orders;
            }
            
            var now = new Date();
            var startDate, endDate;
            
            if (dateFilter === 'custom' && customDateFrom && customDateTo) {
                startDate = new Date(customDateFrom);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(customDateTo);
                endDate.setHours(23, 59, 59, 999);
            } else if (dateFilter === 'today') {
                startDate = new Date(now);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now);
                endDate.setHours(23, 59, 59, 999);
                
                // DEBUG: Ver o range de datas
                console.log('üîç Filtro HOJE:', {
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString(),
                    startLocal: startDate.toLocaleString('pt-BR'),
                    endLocal: endDate.toLocaleString('pt-BR')
                });
            } else if (dateFilter === 'yesterday') {
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 1);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now);
                endDate.setDate(endDate.getDate() - 1);
                endDate.setHours(23, 59, 59, 999);
            } else if (dateFilter === 'week') {
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 7);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now);
                endDate.setHours(23, 59, 59, 999);
            } else if (dateFilter === 'month') {
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() - 30);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now);
                endDate.setHours(23, 59, 59, 999);
            }
            
            return orders.filter(function(o) {
                var orderDate = new Date(o.timestamp || o.createdAt || o.data || 0);
                var isInRange = orderDate >= startDate && orderDate <= endDate;
                
                // DEBUG: Log dos primeiros 3 pedidos para ver os timestamps
                if (orders.indexOf(o) < 3 && dateFilter === 'today') {
                    console.log('üìÖ Pedido', orders.indexOf(o) + 1, ':', {
                        id: o.id.slice(-8),
                        timestamp: o.timestamp,
                        orderDate: orderDate.toISOString(),
                        orderDateLocal: orderDate.toLocaleString('pt-BR'),
                        isInRange: isInRange,
                        diff: Math.floor((new Date() - orderDate) / (1000 * 60 * 60)) + 'h atr√°s'
                    });
                }
                
                return isInRange;
            });
        }
        
        function createOrderCard(order) {
            var status = order.status || 'pending';
            var statusText = getStatusText(status);
            
            // MAPEAR ESTRUTURA DE PEDIDOS ONLINE
            var customerName = 'Cliente';
            if (order.cliente && order.cliente.nome) {
                customerName = order.cliente.nome;
            } else if (order.customer && order.customer.name) {
                customerName = order.customer.name;
            } else if (order.customerName) {
                customerName = order.customerName;
            }
            
            var customerPhone = '';
            if (order.cliente && order.cliente.telefone) {
                customerPhone = order.cliente.telefone;
            } else if (order.customer && order.customer.phone) {
                customerPhone = order.customer.phone;
            } else if (order.phone) {
                customerPhone = order.phone;
            }
            
            var orderNumber = order.number || order.numero || order.id.slice(-4);
            var total = 0;
            if (order.valores && order.valores.total) {
                total = order.valores.total;
            } else if (order.total) {
                total = order.total;
            }
            
            var items = order.itens || order.items || [];
            var orderType = 'balcao';
            if (order.entrega && order.entrega.tipo) {
                orderType = order.entrega.tipo === 'entrega' ? 'delivery' : 'balcao';
            } else if (order.orderType) {
                orderType = order.orderType;
            } else if (order.tipo === 'delivery' || order.tipo === 'entrega') {
                orderType = 'delivery';
            }
            
            var typeIcon = orderType === 'delivery' ? 'motorcycle' : orderType === 'mesa' ? 'utensils' : 'store';
            var typeText = orderType === 'delivery' ? 'üõµ DELIVERY' : orderType === 'mesa' ? 'üçΩÔ∏è MESA' : 'üè™ RETIRADA';
            
            var itemsHtml = '';
            items.slice(0, 3).forEach(function(item) {
                var itemName = item.nome || item.name || 'Item';
                var itemQty = item.quantidade || item.quantity || 1;
                var itemPrice = item.precoTotal || item.precoUnitario || item.price || 0;
                
                itemsHtml += '<div class="order-item">' +
                    '<span><span class="item-qty">' + itemQty + 'x</span> ' + itemName + '</span>' +
                    '<span>R$ ' + itemPrice.toFixed(2) + '</span>' +
                    '</div>';
            });
            
            if (items.length > 3) {
                itemsHtml += '<div class="order-item" style="color: var(--gray); font-style: italic;">+ ' + (items.length - 3) + ' item(s)</div>';
            }
            
            var orderTimestamp = order.timestamp || order.createdAt || order.date;
            var timeAgo = getTimeAgo(orderTimestamp);
            
            return '<div class="order-card ' + status + '">' +
                '<div class="order-header">' +
                    '<div class="order-info">' +
                        '<h3><span class="order-number">#' + orderNumber + '</span> <i class="fas fa-' + typeIcon + '" style="color: var(--gray);"></i></h3>' +
                        '<div class="order-meta">' +
                            '<i class="fas fa-clock"></i> ' + timeAgo + ' | ' + 
                            '<span style="font-weight: bold; color: var(--primary);">' + typeText + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<span class="order-status status-' + status + '">' + statusText + '</span>' +
                '</div>' +
                '<div class="order-body">' +
                    '<div class="order-customer">' +
                        '<div class="customer-avatar">' + customerName.charAt(0).toUpperCase() + '</div>' +
                        '<div class="customer-info">' +
                            '<h4>' + customerName + '</h4>' +
                            '<p>' + (customerPhone || 'Sem telefone') + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="order-items">' + itemsHtml + '</div>' +
                    '<div class="order-total">' +
                        '<span>Total</span>' +
                        '<span class="total-value">R$ ' + total.toFixed(2) + '</span>' +
                    '</div>' +
                '</div>' +
                '<div class="order-actions">' +
                    '<button class="btn btn-primary btn-sm" onclick="editOrder(\'' + order.id + '\')">' +
                        '<i class="fas fa-edit"></i> Editar' +
                    '</button>' +
                    '<button class="btn btn-warning btn-sm" onclick="openStatusModal(\'' + order.id + '\')">' +
                        '<i class="fas fa-exchange-alt"></i> Status' +
                    '</button>' +
                    '<button class="btn btn-secondary btn-sm" onclick="printOrder(\'' + order.id + '\')">' +
                        '<i class="fas fa-print"></i>' +
                    '</button>' +
                    getQuickActionButton(order) +
                '</div>' +
            '</div>';
        }
        
        function getQuickActionButton(order) {
            var status = order.status || 'pending';
            
            switch(status) {
                case 'pending':
                    return '<button class="btn btn-success btn-sm" onclick="quickStatus(\'' + order.id + '\', \'confirmed\')">' +
                        '<i class="fas fa-check"></i> Confirmar</button>';
                case 'confirmed':
                    return '<button class="btn btn-sm" style="background:#8b5cf6;color:white;" onclick="quickStatus(\'' + order.id + '\', \'preparing\')">' +
                        '<i class="fas fa-fire"></i> Preparar</button>';
                case 'preparing':
                    return '<button class="btn btn-success btn-sm" onclick="quickStatus(\'' + order.id + '\', \'ready\')">' +
                        '<i class="fas fa-bell"></i> Pronto!</button>';
                case 'ready':
                    return '<button class="btn btn-secondary btn-sm" onclick="quickStatus(\'' + order.id + '\', \'delivered\')">' +
                        '<i class="fas fa-check-double"></i> Entregar</button>';
                default:
                    return '';
            }
        }
        
        function renderProducts() {
            var container = document.getElementById('products-grid');
            var searchTerm = document.getElementById('product-search').value.toLowerCase();
            
            var filtered = allProducts;
            if (searchTerm) {
                filtered = allProducts.filter(function(p) {
                    var nome = p.name || p.nome || p.titulo || '';
                    return nome.toLowerCase().includes(searchTerm);
                });
            }
            
            // Se nao tem produtos, mostrar opcao de adicionar manualmente
            if (allProducts.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; padding: 20px; text-align: center;">' +
                    '<p style="color: var(--gray); margin-bottom: 15px;">Nenhum produto cadastrado no Firebase</p>' +
                    '<button class="btn btn-primary btn-sm" onclick="openManualProductModal()">' +
                    '<i class="fas fa-plus"></i> Adicionar Produto Manual</button>' +
                    '</div>';
                return;
            }
            
            // Categorizar produtos automaticamente
            var categorias = {
                hamburgueres: { nome: 'üçî HAMB√öRGUERES', icon: 'fas fa-burger', produtos: [] },
                combos: { nome: 'üçü COMBOS', icon: 'fas fa-box', produtos: [] },
                porcoes: { nome: 'üçó POR√á√ïES', icon: 'fas fa-drumstick-bite', produtos: [] },
                bebidas: { nome: 'ü•§ BEBIDAS', icon: 'fas fa-glass-water', produtos: [] }
            };
            
            // Classificar produtos por categoria
            filtered.forEach(function(product) {
                var productName = (product.name || product.nome || product.titulo || '').toLowerCase();
                var categorizado = false;
                
                // COMBOS - Verificar PRIMEIRO (antes de hamb√∫rgueres, pois pode ter nomes como "Combo Chileno")
                if (productName.includes('combo')) {
                    categorias.combos.produtos.push(product);
                    categorizado = true;
                }
                
                // HAMB√öRGUERES - Nomes de pa√≠ses/nacionalidades ou palavras-chave
                if (!categorizado) {
                    var nomesHamburgueres = ['chileno', 'brasileiro', 'franc√™s', 'frances', 'canadense', 'americano', 
                                             'italiano', 'australiano', 'portugu√™s', 'portugues', 'ingl√™s', 'ingles',
                                             'argentino', 'alem√£o', 'alemao', 'paraguaio', 'mexicano', 'espanhol'];
                    var isHamburguer = productName.includes('x-') || productName.includes('burger') || 
                                       productName.includes('hambur') || productName.includes('smash') || 
                                       productName.includes('monte') || nomesHamburgueres.some(function(nome) { 
                                           return productName.includes(nome); 
                                       });
                    
                    if (isHamburguer) {
                        categorias.hamburgueres.produtos.push(product);
                        categorizado = true;
                    }
                }
                
                // POR√á√ïES
                if (!categorizado && (productName.includes('por√ß√£o') || productName.includes('porcao') || 
                    productName.includes('batata') || productName.includes('fritas') || productName.includes('nuggets') || 
                    productName.includes('onion') || productName.includes('an√©is') || productName.includes('aneis') ||
                    productName.includes('cebola'))) {
                    categorias.porcoes.produtos.push(product);
                    categorizado = true;
                }
                
                // BEBIDAS
                if (!categorizado && (productName.includes('coca') || productName.includes('refrigerante') || 
                    productName.includes('suco') || productName.includes('√°gua') || productName.includes('agua') || 
                    productName.includes('bebida') || productName.includes('guaran√°') || productName.includes('guarana') || 
                    productName.includes('sprite') || productName.includes('fanta') || productName.includes('pepsi') || 
                    productName.includes('cerveja'))) {
                    categorias.bebidas.produtos.push(product);
                    categorizado = true;
                }
                
                // Produtos n√£o categorizados v√£o para hamb√∫rgueres por padr√£o
                if (!categorizado) {
                    categorias.hamburgueres.produtos.push(product);
                }
            });
            
            // LOG DE DEBUG - Ver distribui√ß√£o por categoria (simplificado)
            console.log('üìä Categorias:', 
                'üçî', categorias.hamburgueres.produtos.length, 
                '| üçü', categorias.combos.produtos.length,
                '| üçó', categorias.porcoes.produtos.length, 
                '| ü•§', categorias.bebidas.produtos.length);
            
            var html = '';
            
            // Botao para adicionar produto manual no in√≠cio
            html += '<div class="product-item" onclick="openManualProductModal()" style="border: 2px dashed var(--gray); grid-column: 1 / -1;">' +
                '<div class="name" style="text-align: center;"><i class="fas fa-plus"></i> Adicionar Produto Manual</div>' +
                '<div class="price" style="color: var(--gray); text-align: center;">Cadastrar Novo</div>' +
                '</div>';
            
            // Renderizar cada categoria com seus produtos
            var categoriasOrdem = ['hamburgueres', 'combos', 'porcoes', 'bebidas'];
            categoriasOrdem.forEach(function(catKey) {
                var categoria = categorias[catKey];
                if (categoria.produtos.length > 0) {
                    // Cabe√ßalho da categoria
                    html += '<div class="product-category-header">' +
                        '<i class="' + categoria.icon + '"></i>' +
                        '<span>' + categoria.nome + '</span>' +
                        '<span style="margin-left: auto; background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 12px; font-size: 12px;">' +
                        categoria.produtos.length + ' item(s)</span>' +
                        '</div>';
                    
                    // Produtos da categoria
                    categoria.produtos.forEach(function(product) {
                        var isInCart = cartItems.some(function(item) { return item.id === product.id; });
                        var productName = product.name || product.nome || product.titulo || 'Produto';
                        var productPrice = product.price || product.preco || product.valor || 0;
                        
                        // Bebidas n√£o t√™m customiza√ß√£o, apenas adicionar direto ao carrinho
                        var clickAction = catKey === 'bebidas' 
                            ? 'addToCart(\'' + product.id + '\')' 
                            : 'openCustomizeModal(\'' + product.id + '\')';
                        
                        var customizeLabel = catKey === 'bebidas' 
                            ? '' 
                            : ' <small style="color:var(--primary);font-size:0.8em;"><i class="fas fa-edit"></i></small>';
                        
                        html += '<div class="product-item ' + (isInCart ? 'selected' : '') + '" onclick="' + clickAction + '">' +
                            '<div class="name">' + productName + customizeLabel + '</div>' +
                            '<div class="price">R$ ' + productPrice.toFixed(2) + '</div>' +
                            '</div>';
                    });
                }
            });
            
            container.innerHTML = html;
        }
        
        function renderCart() {
            var container = document.getElementById('cart-items');
            var totalEl = document.getElementById('cart-total');
            
            if (cartItems.length === 0) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 20px;">Adicione produtos ao pedido</p>';
                totalEl.classList.add('hidden');
                return;
            }
            
            var html = '';
            var subtotal = 0;
            
            cartItems.forEach(function(item) {
                var itemSubtotal = item.price * item.quantity;
                subtotal += itemSubtotal;
                
                var adicionaisText = '';
                if (item.adicionais && item.adicionais.length > 0) {
                    adicionaisText = '<div style="font-size:0.85em;color:var(--gray);margin-top:3px;">' + 
                        item.adicionais.join(', ') + '</div>';
                }
                
                html += '<div class="cart-item">' +
                    '<div class="cart-item-info">' +
                        '<div class="name">' + item.name + adicionaisText + '</div>' +
                        '<div class="price">R$ ' + item.price.toFixed(2) + ' cada</div>' +
                    '</div>' +
                    '<div class="cart-item-qty">' +
                        '<button class="qty-btn" onclick="updateCartQty(\'' + item.id + '\', -1)">-</button>' +
                        '<span class="qty-value">' + item.quantity + '</span>' +
                        '<button class="qty-btn" onclick="updateCartQty(\'' + item.id + '\', 1)">+</button>' +
                    '</div>' +
                    '<i class="fas fa-trash cart-item-remove" onclick="removeFromCart(\'' + item.id + '\')"></i>' +
                '</div>';
            });
            
            // Calcular taxa de entrega
            var orderType = document.getElementById('order-type') ? document.getElementById('order-type').value : 'balcao';
            var taxaEntrega = orderType === 'delivery' ? 10.00 : 0;
            var total = subtotal + taxaEntrega;
            
            // Adicionar resumo de valores
            if (taxaEntrega > 0) {
                html += '<div style="padding:10px;margin-top:10px;border-top:2px dashed #ddd;">' +
                    '<div style="display:flex;justify-content:space-between;margin-bottom:5px;">' +
                        '<span style="color:#666;">Subtotal:</span>' +
                        '<span>R$ ' + subtotal.toFixed(2) + '</span>' +
                    '</div>' +
                    '<div style="display:flex;justify-content:space-between;margin-bottom:5px;">' +
                        '<span style="color:#666;">Taxa de Entrega:</span>' +
                        '<span style="color:var(--warning);">+R$ ' + taxaEntrega.toFixed(2) + '</span>' +
                    '</div>' +
                '</div>';
            }
            
            container.innerHTML = html;
            document.getElementById('total-value').textContent = 'R$ ' + total.toFixed(2);
            totalEl.classList.remove('hidden');
        }
        
        function updateStats() {
            var counts = {
                all: allOrders.filter(function(o) { return o.status !== 'cancelled'; }).length,
                pending: allOrders.filter(function(o) { return (o.status || 'pending') === 'pending'; }).length,
                confirmed: allOrders.filter(function(o) { return o.status === 'confirmed'; }).length,
                preparing: allOrders.filter(function(o) { return o.status === 'preparing' || o.status === 'em_preparo'; }).length,
                ready: allOrders.filter(function(o) { return o.status === 'ready' || o.status === 'pronto'; }).length,
                delivered: allOrders.filter(function(o) { return o.status === 'delivered' || o.status === 'entregue'; }).length
            };
            
            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-pending').textContent = counts.pending;
            document.getElementById('count-confirmed').textContent = counts.confirmed;
            document.getElementById('count-preparing').textContent = counts.preparing;
            document.getElementById('count-ready').textContent = counts.ready;
            document.getElementById('count-delivered').textContent = counts.delivered;
        }
        
        // ========================================
        // ACOES
        // ========================================
        
        function filterOrders(filter) {
            currentFilter = filter;
            
            // Update active state
            document.querySelectorAll('.stat-item').forEach(function(el) {
                el.classList.remove('active');
            });
            document.querySelector('.stat-item[data-filter="' + filter + '"]').classList.add('active');
            
            renderOrders();
        }
        
        function filterProducts() {
            renderProducts();
        }
        
        function filterByDate(period) {
            dateFilter = period;
            customDateFrom = null;
            customDateTo = null;
            
            // Resetar inputs de data personalizada
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            
            // Update active state
            document.querySelectorAll('.date-filter-btn').forEach(function(el) {
                el.classList.remove('active');
            });
            document.querySelector('.date-filter-btn[data-period="' + period + '"]').classList.add('active');
            
            renderOrders();
        }
        
        function filterByCustomDate() {
            var dateFrom = document.getElementById('date-from').value;
            var dateTo = document.getElementById('date-to').value;
            
            if (dateFrom && dateTo) {
                dateFilter = 'custom';
                customDateFrom = dateFrom;
                customDateTo = dateTo;
                
                // Update active state
                document.querySelectorAll('.date-filter-btn').forEach(function(el) {
                    el.classList.remove('active');
                });
                
                renderOrders();
            }
        }
        
        function openNewOrderModal() {
            editingOrderId = null;
            document.getElementById('modal-title').textContent = 'Novo Pedido';
            document.getElementById('order-form').reset();
            cartItems = [];
            renderCart();
            renderProducts();
            handleOrderTypeChange();
            document.getElementById('order-modal').classList.add('active');
        }
        
        function editOrder(orderId) {
            var order = allOrders.find(function(o) { return o.id === orderId; });
            if (!order) return;
            
            editingOrderId = orderId;
            document.getElementById('modal-title').textContent = 'Editar Pedido #' + (order.number || orderId.slice(-4));
            document.getElementById('order-id').value = orderId;
            
            // Mapear campos do pedido online
            document.getElementById('customer-name').value = (order.cliente && order.cliente.nome) || (order.customer && order.customer.name) || order.customerName || '';
            document.getElementById('customer-phone').value = (order.cliente && order.cliente.telefone) || (order.customer && order.customer.phone) || order.phone || '';
            
            var orderType = 'balcao';
            if (order.entrega && order.entrega.tipo === 'entrega') {
                orderType = 'delivery';
            } else if (order.orderType) {
                orderType = order.orderType;
            } else if (order.tipo === 'delivery' || order.tipo === 'entrega') {
                orderType = 'delivery';
            }
            document.getElementById('order-type').value = orderType;
            
            document.getElementById('delivery-address').value = (order.cliente && order.cliente.endereco) || (order.entrega && order.entrega.endereco) || order.deliveryAddress || order.address || '';
            document.getElementById('table-number').value = order.tableNumber || '';
            document.getElementById('order-notes').value = order.observacoes || order.notes || order.observations || '';
            
            // Carregar itens no carrinho
            var items = order.itens || order.items || [];
            cartItems = items.map(function(item) {
                return {
                    id: item.id || item.productId || generateId(),
                    name: item.nome || item.name || 'Item',
                    price: item.precoUnitario || item.price || 0,
                    quantity: item.quantidade || item.quantity || 1
                };
            });
            
            renderCart();
            renderProducts();
            handleOrderTypeChange();
            document.getElementById('order-modal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('order-modal').classList.remove('active');
            editingOrderId = null;
        }
        
        function handleOrderTypeChange() {
            var type = document.getElementById('order-type').value;
            var addressGroup = document.getElementById('address-group');
            var tableGroup = document.getElementById('table-group');
            
            if (type === 'delivery') {
                addressGroup.classList.remove('hidden');
            } else {
                addressGroup.classList.add('hidden');
            }
            
            if (type === 'mesa') {
                tableGroup.classList.remove('hidden');
            } else {
                tableGroup.classList.add('hidden');
            }
            
            // Atualizar carrinho para recalcular taxa de entrega
            renderCart();
        }
        
        function addToCart(productId) {
            var product = allProducts.find(function(p) { return p.id === productId; });
            if (!product) return;
            
            var existing = cartItems.find(function(item) { return item.id === productId; });
            if (existing) {
                existing.quantity++;
            } else {
                cartItems.push({
                    id: product.id,
                    name: product.name,
                    price: product.price || 0,
                    quantity: 1,
                    adicionais: product.adicionais || []
                });
            }
            
            renderCart();
            renderProducts();
        }
        
        function updateCartQty(itemId, delta) {
            var item = cartItems.find(function(i) { return i.id === itemId; });
            if (!item) return;
            
            item.quantity += delta;
            if (item.quantity <= 0) {
                removeFromCart(itemId);
                return;
            }
            
            renderCart();
        }
        
        function removeFromCart(itemId) {
            cartItems = cartItems.filter(function(i) { return i.id !== itemId; });
            renderCart();
            renderProducts();
        }
        
        // ========================================
        // CUSTOMIZACAO DE PRODUTOS
        // ========================================
        
        var selectedIngredients = [];
        var customizingProductId = null;
        var currentCustomizations = []; // Customiza√ß√µes do banco (ponto da carne, etc)
        var selectedCustomizations = {}; // {groupName: [selectedOptions]}
        
        function getDefaultCustomizations() {
            return [
                {
                    name: 'Ponto da Carne',
                    type: 'single',
                    required: true,
                    options: [
                        { id: 'mal-passado', name: 'Mal passado', price: 0 },
                        { id: 'ao-ponto', name: 'Ao ponto', price: 0, default: true },
                        { id: 'bem-passado', name: 'Bem passado', price: 0 }
                    ]
                },
                {
                    name: 'P√£es',
                    type: 'multiple',
                    required: false,
                    options: [
                        { id: 'pao-gergelim', name: 'üçî P√£o Gergelim', price: 5.00 },
                       
                    ]
                },
                {
                    name: 'Molhos',
                    type: 'multiple',
                    required: false,
                    options: [
                        { id: 'maionese-verde', name: 'üåø Maionese Verde', price: 4.00 },
                        { id: 'maionese-bacon', name: 'ü•ì Maionese de Bacon', price: 6.00 },
                        { id: 'barbecue', name: 'üî• Barbecue', price: 4.00 },
                        { id: 'molho-especial', name: '‚≠ê Molho Especial', price: 5.00 },
                        { id: 'ketchup', name: 'üçÖ Ketchup', price: 4.00 },
                        { id: 'mostarda', name: 'üå∂Ô∏è Mostarda', price: 4.00 }
                    ]
                },
                {
                    name: 'Carnes',
                    type: 'multiple',
                    required: false,
                    options: [
                        { id: 'burger-tradicional', name: 'üçî Burger Tradicional', price: 10.00 },
                        { id: 'burger-linguica', name: 'üå≠ Burger de Lingui√ßa', price: 10.00 },
                        { id: 'burger-costela', name: 'ü•© Burger de Costela desfiada', price: 12.00 },
                        { id: 'burger-frango', name: 'üçó Frango Empanado', price: 10.00 },
                        { id: 'bacon', name: 'ü•ì Bacon', price: 7.00 },
                    ]
                },
                {
                    name: 'Queijos',
                    type: 'multiple',
                    required: false,
                    options: [
                        { id: 'cheddar', name: 'üßÄ Cheddar', price: 6.00 },
                        { id: 'mussarela', name: 'üßÄ Mussarela', price: 5.00 },
                       
                    ]
                },
                {
                    name: 'Adicionais',
                    type: 'multiple',
                    required: false,
                    options: [
                        { id: 'batata', name: 'üçü Batata Frita', price: 6.00 },
                        { id: 'cebola-empanada', name: 'üßÖ Cebola Empanada', price: 6.00 },
                        { id: 'cebola-caramelizada', name: 'üßÖ Cebola Caramelizada', price: 4.00 },
                        { id: 'tomate', name: 'üçÖ Tomate', price: 2.00 },
                        { id: 'alface', name: 'ü•¨ Alface', price: 2.00 },
                        { id: 'picles', name: 'ü•í Picles', price: 2.00 },
                        { id: 'abacaxi', name: 'üçç Abacaxi', price: 4.00 }
                    ]
                }
            ];
        }
        
        async function loadCustomizationsFromDB() {
            try {
                // Carregar do Firebase
                if (!database) {
                    console.warn('‚ö†Ô∏è Firebase database n√£o dispon√≠vel, usando customiza√ß√µes padr√£o');
                    return getDefaultCustomizations();
                }
                
                var settingsRef = database.ref('settings');
                var snapshot = await settingsRef.once('value');
                var allSettings = snapshot.val();
                
                if (!allSettings) {
                    console.log('‚ö†Ô∏è Nenhuma configura√ß√£o encontrada, usando padr√£o');
                    return getDefaultCustomizations();
                }
                
                // Procurar settings com customiza√ß√µes
                var settingsArray = Object.values(allSettings);
                var settings = settingsArray.find(function(s) { 
                    return s && (s.id === 'settings-1' || s.customizations); 
                });
                
                if (settings && settings.customizations) {
                    console.log('‚úÖ Customiza√ß√µes carregadas do Firebase:', settings.customizations.length);
                    return settings.customizations;
                } else {
                    console.log('‚ö†Ô∏è Nenhuma customiza√ß√£o no Firebase, usando padr√£o');
                    return getDefaultCustomizations();
                }
                
            } catch (error) {
                // Silenciar erro de permiss√£o - usar customiza√ß√µes padr√£o
                if (!error.message.includes('permission_denied')) {
                    console.warn('‚ö†Ô∏è Erro ao carregar customiza√ß√µes:', error.message);
                }
                return getDefaultCustomizations();
            }
        }
        
        async function openCustomizeModal(productId) {
            var product = allProducts.find(function(p) { return p.id === productId; });
            if (!product) return;
            
            customizingProductId = productId;
            selectedIngredients = [];
            selectedCustomizations = {};
            
            document.getElementById('customize-product-id').value = productId;
            document.getElementById('customize-product-name').textContent = product.name;
            document.getElementById('customize-notes').value = '';
            
            // Carregar customiza√ß√µes do banco
            currentCustomizations = await loadCustomizationsFromDB();
            
            if (currentCustomizations.length > 0) {
                // Modo avan√ßado: renderizar grupos de customiza√ß√£o
                renderAdvancedCustomizations(product);
            } else {
                // Modo simples: lista de ingredientes
                renderSimpleIngredients(product);
            }
            
            document.getElementById('customize-modal').classList.add('active');
        }
        
        function renderAdvancedCustomizations(product) {
            var container = document.getElementById('customizations-container');
            var simpleContainer = document.getElementById('simple-ingredients-container');
            var summaryDiv = document.getElementById('customization-summary');
            
            container.style.display = 'block';
            simpleContainer.style.display = 'none';
            summaryDiv.style.display = 'block';
            
            var html = '';
            
            currentCustomizations.forEach(function(group, groupIndex) {
                var isSingle = group.type === 'single';
                var inputType = isSingle ? 'radio' : 'checkbox';
                var inputName = isSingle ? 'custom-group-' + groupIndex : '';
                
                html += '<div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">';
                html += '<strong style="display: block; margin-bottom: 12px; color: #333; font-size: 1em;">';
                html += group.name;
                if (group.required) {
                    html += ' <span style="color: #e74c3c;">*</span>';
                }
                html += '</strong>';
                
                html += '<div style="display: grid; gap: 8px;">';
                
                group.options.forEach(function(option, optIndex) {
                    var optionId = 'opt-' + groupIndex + '-' + optIndex;
                    var isDefault = option.default === true;
                    var checked = isDefault ? 'checked' : '';
                    
                    // Se √© default, j√° adicionar na sele√ß√£o
                    if (isDefault && isSingle) {
                        if (!selectedCustomizations[group.name]) {
                            selectedCustomizations[group.name] = [];
                        }
                        selectedCustomizations[group.name] = [option];
                    }
                    
                    html += '<label style="display: flex; align-items: center; padding: 10px; cursor: pointer; border-radius: 6px; transition: all 0.2s; background: #f8f9fa;" class="custom-option-label" onmouseover="this.style.background=\'#e9ecef\'" onmouseout="this.style.background=\'#f8f9fa\'">';
                    html += '<input type="' + inputType + '" ';
                    if (inputName) html += 'name="' + inputName + '" ';
                    html += 'id="' + optionId + '" ';
                    html += 'value="' + optIndex + '" ';
                    html += checked + ' ';
                    html += 'onchange="handleCustomizationChange(' + groupIndex + ', ' + optIndex + ', this.checked)" ';
                    html += 'style="margin-right: 10px; cursor: pointer;">';
                    html += '<span style="flex: 1;">' + option.name + '</span>';
                    
                    if (option.price > 0) {
                        html += '<span style="color: var(--primary); font-weight: 600;">+R$ ' + option.price.toFixed(2) + '</span>';
                    } else {
                        html += '<span style="color: var(--success); font-weight: 500;">Gr√°tis</span>';
                    }
                    
                    html += '</label>';
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
            updateCustomizationSummary(product);
        }
        
        function renderSimpleIngredients(product) {
            var container = document.getElementById('customizations-container');
            var simpleContainer = document.getElementById('simple-ingredients-container');
            var list = document.getElementById('ingredients-list');
            var summaryDiv = document.getElementById('customization-summary');
            
            container.style.display = 'none';
            simpleContainer.style.display = 'block';
            summaryDiv.style.display = 'none';
            
            var html = '';
            var ingredients = product.adicionais || [];
            
            if (ingredients.length === 0) {
                html = '<p style="color: var(--gray); text-align: center; padding: 20px;">Nenhum ingrediente dispon√≠vel para customiza√ß√£o</p>';
            } else {
                ingredients.forEach(function(ing, index) {
                    var ingredientName = typeof ing === 'string' ? ing : (ing.nome || ing.name || 'Ingrediente');
                    html += '<div class="ingredient-item" onclick="toggleIngredient(' + index + ')">';
                    html += '<input type="checkbox" id="ing-' + index + '" onchange="toggleIngredient(' + index + ')">';
                    html += '<label for="ing-' + index + '">' + ingredientName + '</label>';
                    html += '</div>';
                });
            }
            
            list.innerHTML = html;
        }
        
        function handleCustomizationChange(groupIndex, optionIndex, isChecked) {
            var group = currentCustomizations[groupIndex];
            var option = group.options[optionIndex];
            
            if (!selectedCustomizations[group.name]) {
                selectedCustomizations[group.name] = [];
            }
            
            if (group.type === 'single') {
                // Radio: apenas uma op√ß√£o
                selectedCustomizations[group.name] = isChecked ? [option] : [];
            } else {
                // Checkbox: m√∫ltiplas op√ß√µes
                if (isChecked) {
                    if (!selectedCustomizations[group.name].find(function(o) { return o.id === option.id; })) {
                        selectedCustomizations[group.name].push(option);
                    }
                } else {
                    selectedCustomizations[group.name] = selectedCustomizations[group.name].filter(function(o) { 
                        return o.id !== option.id; 
                    });
                }
            }
            
            var product = allProducts.find(function(p) { return p.id === customizingProductId; });
            updateCustomizationSummary(product);
        }
        
        function updateCustomizationSummary(product) {
            var summaryContent = document.getElementById('summary-content');
            var totalPriceEl = document.getElementById('custom-total-price');
            
            var basePrice = product.price || product.preco || 0;
            var additionalPrice = 0;
            var html = '';
            
            Object.keys(selectedCustomizations).forEach(function(groupName) {
                var options = selectedCustomizations[groupName];
                if (options.length > 0) {
                    html += '<div style="margin-bottom: 8px;">';
                    html += '<strong style="color: #666;">' + groupName + ':</strong> ';
                    
                    var optionTexts = options.map(function(opt) {
                        additionalPrice += opt.price || 0;
                        var priceText = opt.price > 0 ? ' (+R$ ' + opt.price.toFixed(2) + ')' : '';
                        return opt.name + priceText;
                    });
                    
                    html += optionTexts.join(', ');
                    html += '</div>';
                }
            });
            
            if (html === '') {
                html = '<p style="color: #999; font-style: italic;">Nenhuma customiza√ß√£o selecionada</p>';
            }
            
            summaryContent.innerHTML = html;
            var totalPrice = basePrice + additionalPrice;
            totalPriceEl.textContent = 'R$ ' + totalPrice.toFixed(2);
        }
        
        function toggleIngredient(index) {
            var checkbox = document.getElementById('ing-' + index);
            var item = checkbox.closest('.ingredient-item');
            
            if (checkbox.checked) {
                item.classList.add('selected');
                if (!selectedIngredients.includes(index)) {
                    selectedIngredients.push(index);
                }
            } else {
                item.classList.remove('selected');
                selectedIngredients = selectedIngredients.filter(function(i) { return i !== index; });
            }
        }
        
        function addCustomizedToCart() {
            var product = allProducts.find(function(p) { return p.id === customizingProductId; });
            if (!product) return;
            
            var notes = document.getElementById('customize-notes').value;
            var customId = product.id + '-' + Date.now();
            
            // Verificar modo de customiza√ß√£o
            if (currentCustomizations.length > 0) {
                // Modo avan√ßado: validar campos obrigat√≥rios
                var missingRequired = currentCustomizations.filter(function(group) {
                    return group.required && (!selectedCustomizations[group.name] || selectedCustomizations[group.name].length === 0);
                });
                
                if (missingRequired.length > 0) {
                    showToast('Por favor, selecione: ' + missingRequired[0].name, 'error');
                    return;
                }
                
                // Calcular pre√ßo total
                var basePrice = product.price || product.preco || 0;
                var additionalPrice = 0;
                var customizationDetails = {};
                
                Object.keys(selectedCustomizations).forEach(function(groupName) {
                    var options = selectedCustomizations[groupName];
                    customizationDetails[groupName] = options.map(function(opt) {
                        additionalPrice += opt.price || 0;
                        return opt.name;
                    });
                });
                
                var totalPrice = basePrice + additionalPrice;
                
                cartItems.push({
                    id: customId,
                    name: product.name,
                    price: totalPrice,
                    quantity: 1,
                    customizations: customizationDetails,
                    observacoes: notes,
                    customized: true
                });
                
                showToast('‚úÖ ' + product.name + ' customizado adicionado!', 'success');
                
            } else {
                // Modo simples: ingredientes
                if (selectedIngredients.length === 0) {
                    showToast('Selecione pelo menos um ingrediente', 'error');
                    return;
                }
                
                var selectedNames = selectedIngredients.map(function(index) {
                    var ing = product.adicionais[index];
                    return typeof ing === 'string' ? ing : (ing.nome || ing.name || 'Ingrediente');
                });
                
                cartItems.push({
                    id: customId,
                    name: product.name,
                    price: product.price || 0,
                    quantity: 1,
                    adicionais: selectedNames,
                    observacoes: notes,
                    customized: true
                });
                
                showToast('‚úÖ Produto customizado adicionado!', 'success');
            }
            
            closeCustomizeModal();
            renderCart();
            renderProducts();
        }
        
        function closeCustomizeModal() {
            document.getElementById('customize-modal').classList.remove('active');
            selectedIngredients = [];
            selectedCustomizations = {};
            customizingProductId = null;
        }
        
        // ========================================
        // IMPRESSAO DE PEDIDOS
        // ========================================
        
        function printOrder(orderId) {
            var order = allOrders.find(function(o) { return o.id === orderId; });
            if (!order) {
                showToast('Pedido nao encontrado', 'error');
                return;
            }
            
            // DADOS DA EMPRESA (buscar das configura√ß√µes ou usar padr√£o)
            var companyName = 'GO BURGER';
            var companyPhone = '(66) 9 9912-2668';
            var companyAddress = 'Querencia MT';
            var companyCNPJ = '62.580.613/0001-00';
            
            var customerName = (order.cliente && order.cliente.nome) || (order.customer && order.customer.name) || order.customerName || 'Cliente';
            var customerPhone = (order.cliente && order.cliente.telefone) || (order.customer && order.customer.phone) || order.customerPhone || '';
            var orderNumber = order.number || order.numero || order.id.slice(-8).toUpperCase();
            var items = order.itens || order.items || [];
            var total = (order.valores && order.valores.total) || order.total || 0;
            
            // Detectar tipo de pedido (m√∫ltiplas formas)
            var orderType = 'RETIRADA'; // padr√£o
            if (order.entrega && order.entrega.tipo === 'entrega') {
                orderType = 'DELIVERY';
            } else if (order.orderType === 'delivery') {
                orderType = 'DELIVERY';
            } else if (order.tipo === 'delivery' || order.tipo === 'entrega') {
                orderType = 'DELIVERY';
            }
            
            var address = (order.entrega && order.entrega.endereco) || (order.cliente && order.cliente.endereco) || order.deliveryAddress || order.address || '';
            var orderDate = new Date(order.timestamp || order.createdAt || order.date || Date.now());
            
            // LOG DE DIAGN√ìSTICO DA IMPRESS√ÉO
            console.log('=== IMPRESS√ÉO DE PEDIDO ===');
            console.log('ID:', orderId);
            console.log('Total de itens:', items.length);
            console.log('Estrutura completa do primeiro item:', items[0] ? JSON.stringify(items[0], null, 2) : 'Nenhum item');
            
            // Montar HTML dos itens com ponto da carne em destaque
            var itemsHtml = '';
            items.forEach(function(item, itemIndex) {
                var itemName = item.nome || item.name || 'Item';
                var qty = item.quantidade || item.quantity || 1;
                
                // Se tem precoTotal, √© o total j√° calculado. Se tem precoUnitario, multiplica pela qtd
                var price = item.precoTotal || ((item.precoUnitario || item.price || 0) * qty);
                
                var customizations = item.customizations || item.personalizacao || item.customizacoes || {};
                var adicionais = item.adicionais || item.extras || item.ingredients || [];
                var obs = item.observacoes || item.observacao || item.notes || item.obs || '';
                var pontoCarne = item.pontoCarne || item.meatDoneness || item.ponto_carne || item.pontoDaCarne || '';
                var descricao = item.descricao || item.description || item.desc || '';
                
                // TENTAR EXTRAIR PONTO DA CARNE DE CUSTOMIZATIONS ESTRUTURADO
                if (!pontoCarne && customizations && typeof customizations === 'object') {
                    // Verificar se tem estrutura de customiza√ß√µes {"Ponto da Carne": [...]}
                    Object.keys(customizations).forEach(function(key) {
                        var keyLower = key.toLowerCase();
                        if ((keyLower.includes('ponto') && keyLower.includes('carne')) || keyLower === 'ponto') {
                            var value = customizations[key];
                            if (Array.isArray(value) && value.length > 0) {
                                // Pode ser array de objetos {name: "Mal Passado"} ou array de strings
                                var firstItem = value[0];
                                pontoCarne = typeof firstItem === 'string' ? firstItem : (firstItem.name || firstItem.label || firstItem.value || '');
                            } else if (typeof value === 'string') {
                                pontoCarne = value;
                            } else if (value && typeof value === 'object') {
                                pontoCarne = value.name || value.label || value.value || '';
                            }
                        }
                    });
                }
                
                // LOG DE DEBUG POR ITEM
                console.log('Item ' + (itemIndex + 1) + ':', itemName);
                console.log('  - Ponto da carne:', pontoCarne || 'N√ÉO ENCONTRADO');
                console.log('  - Adicionais:', adicionais);
                console.log('  - Customizations:', customizations);
                console.log('  - Descri√ß√£o:', descricao);
                
                itemsHtml += '<div class="item">';
                itemsHtml += '<div><span style="font-weight:bold;">' + qty + 'x</span> ' + itemName + ' - <span style="font-weight:bold;">R$ ' + price.toFixed(2) + '</span></div>';
                
                // EXTRAIR APENAS PONTO DA CARNE DA DESCRI√á√ÉO (n√£o mostrar ingredientes padr√£o)
                if (descricao && !pontoCarne) {
                    // Separar descri√ß√£o e ponto da carne
                    var partes = descricao.split(' - Ponto:');
                    var pontoNaDescricao = partes[1] ? partes[1].split(' - Obs:')[0].trim() : '';
                    
                    // Se tem ponto na descri√ß√£o e n√£o veio no campo separado
                    if (pontoNaDescricao) {
                        pontoCarne = pontoNaDescricao;
                    }
                }
                
                // PONTO DA CARNE - DESTAQUE AMARELO (campo direto ou extra√≠do da descri√ß√£o)
                if (pontoCarne) {
                    itemsHtml += '<div style="background:#ffeb3b;padding:3px 8px;margin:4px 0 4px 15px;display:inline-block;font-weight:bold;">üî• PONTO: ' + pontoCarne.toUpperCase() + '</div>';
                }
                
                // (Processamento de customizations movido para cima para evitar duplica√ß√£o)
                
                // ADICIONAIS - Processar de m√∫ltiplas formas
                if (adicionais && (adicionais.length > 0 || typeof adicionais === 'string')) {
                    // Se adicionais √© string, converter para array
                    var adicionaisArray = typeof adicionais === 'string' 
                        ? adicionais.split(/[,+\n]/).map(function(a) { return a.trim(); }).filter(function(a) { return a.length > 0; })
                        : adicionais;
                    
                    if (Array.isArray(adicionaisArray) && adicionaisArray.length > 0) {
                        adicionaisArray.forEach(function(adic) {
                            var nome = typeof adic === 'string' ? adic : (adic.nome || adic.name || adic.label || '');
                            if (nome) itemsHtml += '<div class="item-details">+ ' + nome + '</div>';
                        });
                    }
                }
                
                // BUSCAR ADICIONAIS EM CUSTOMIZATIONS (se n√£o encontrou no campo direto)
                if ((!adicionais || adicionais.length === 0) && customizations && typeof customizations === 'object') {
                    Object.keys(customizations).forEach(function(key) {
                        var keyLower = key.toLowerCase();
                        // Ignorar ponto da carne (j√° foi processado)
                        if (keyLower.includes('ponto') && keyLower.includes('carne')) return;
                        if (keyLower === 'ponto') return;
                        
                        var value = customizations[key];
                        if (Array.isArray(value) && value.length > 0) {
                            // Array de adicionais
                            value.forEach(function(v) {
                                var nome = typeof v === 'string' ? v : (v.name || v.label || v.value || '');
                                if (nome) itemsHtml += '<div class="item-details">+ ' + nome + '</div>';
                            });
                        } else if (typeof value === 'string' && value) {
                            itemsHtml += '<div class="item-details">+ ' + value + '</div>';
                        } else if (value && typeof value === 'object' && (value.name || value.label)) {
                            itemsHtml += '<div class="item-details">+ ' + (value.name || value.label) + '</div>';
                        }
                    });
                }
                
                // Observa√ß√µes
                if (obs) {
                    itemsHtml += '<div class="item-details">üí¨ Obs: ' + obs + '</div>';
                }
                
                itemsHtml += '</div>';
            });
            
            // Criar janela de impress√£o
            var printWindow = window.open('', '_blank', 'width=300,height=600');
            
            var printContent = '<!DOCTYPE html><html><head><meta charset="UTF-8">' +
                '<title>Pedido #' + orderNumber + '</title>' +
                '<style>' +
                '@page { margin: 0; size: 80mm auto; }' +
                '* { margin: 0; padding: 0; box-sizing: border-box; }' +
                'body { font-family: "Courier New", monospace; font-size: 12px; padding: 10px; width: 300px; margin: 0 auto; }' +
                '.header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }' +
                '.logo { font-size: 18px; font-weight: bold; margin-bottom: 5px; }' +
                '.company-info { font-size: 10px; line-height: 1.4; }' +
                '.order-number { background: #000; color: #fff; padding: 8px; margin: 10px 0; text-align: center; font-weight: bold; font-size: 14px; }' +
                '.section { margin: 10px 0; border-bottom: 1px dashed #000; padding-bottom: 10px; }' +
                '.label { font-weight: bold; font-size: 13px; margin-bottom: 5px; }' +
                '.item { margin: 8px 0; padding-bottom: 8px; border-bottom: 1px dotted #ccc; }' +
                '.item-details { font-size: 10px; margin-left: 15px; color: #555; margin-top: 3px; }' +
                '.total { font-size: 16px; font-weight: bold; text-align: right; margin-top: 10px; border-top: 2px solid #000; padding-top: 8px; }' +
                '.footer { text-align: center; margin-top: 15px; font-size: 11px; border-top: 1px dashed #000; padding-top: 10px; }' +
                '@media print { body { width: 80mm; } }' +
                '</style></head><body>' +
                '<div class="header">' +
                '<div class="logo">üçî ' + companyName + '</div>' +
                '<div class="company-info">' + companyAddress + '<br>Tel: ' + companyPhone + '<br>CNPJ: ' + companyCNPJ + '</div>' +
                '</div>' +
                '<div class="order-number">PEDIDO #' + orderNumber + '</div>' +
                '<div style="text-align:center;font-size:11px;margin-bottom:10px;">' + orderDate.toLocaleString('pt-BR') + '</div>' +
                '<div style="text-align:center;font-weight:bold;margin-bottom:10px;">' + (orderType === 'DELIVERY' ? 'üõµ DELIVERY' : 'üè™ RETIRADA') + '</div>' +
                '<div class="section">' +
                '<div class="label">CLIENTE:</div>' +
                '<div>' + customerName + '</div>' +
                (customerPhone ? '<div>' + customerPhone + '</div>' : '') +
                (address && orderType === 'DELIVERY' ? '<div style="margin-top: 5px;">Endereco: ' + address + '</div>' : '') +
                '</div>' +
                '<div class="section">' +
                '<div class="label">ITENS:</div>' +
                itemsHtml +
                '</div>' +
                (order.observacoes ? '<div class="section"><div class="label">OBSERVA\u00c7\u00d5ES:</div><div>' + order.observacoes + '</div></div>' : '') +
                '<div class="total">TOTAL: R$ ' + total.toFixed(2) + '</div>' +
                '<div class="footer">' +
                '<div>Obrigado pela prefer\u00eancia!</div>' +
                '<div style="margin-top: 5px;">Volte sempre!</div>' +
                '</div>' +
                '</body></html>';
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            setTimeout(function() {
                printWindow.print();
            }, 250);
        }
        
        async function saveOrder() {
            var customerName = document.getElementById('customer-name').value.trim();
            var customerPhone = document.getElementById('customer-phone').value.trim();
            var orderType = document.getElementById('order-type').value;
            var deliveryAddress = document.getElementById('delivery-address').value.trim();
            var tableNumber = document.getElementById('table-number').value;
            var notes = document.getElementById('order-notes').value.trim();
            
            if (!customerName) {
                showToast('Informe o nome do cliente', 'warning');
                return;
            }
            
            if (cartItems.length === 0) {
                showToast('Adicione pelo menos um produto', 'warning');
                return;
            }
            
            var total = cartItems.reduce(function(sum, item) {
                return sum + (item.price * item.quantity);
            }, 0);
            
            // Estrutura compat√≠vel com pedidos online
            var orderData = {
                cliente: {
                    nome: customerName,
                    telefone: customerPhone,
                    endereco: orderType === 'delivery' ? deliveryAddress : ''
                },
                entrega: {
                    tipo: orderType === 'delivery' ? 'entrega' : 'retirada',
                    endereco: orderType === 'delivery' ? deliveryAddress : ''
                },
                itens: cartItems.map(function(item) {
                    var itemData = {
                        nome: item.name,
                        quantidade: item.quantity,
                        precoUnitario: item.price,
                        precoTotal: item.price * item.quantity
                    };
                    
                    // Adicionar adicionais se existirem
                    if (item.adicionais && item.adicionais.length > 0) {
                        itemData.adicionais = item.adicionais;
                    }
                    
                    // Adicionar observa√ß√µes se existirem
                    if (item.observacoes) {
                        itemData.observacoes = item.observacoes;
                    }
                    
                    return itemData;
                }),
                valores: {
                    subtotal: total,
                    taxaEntrega: orderType === 'delivery' ? 10 : 0,
                    desconto: 0,
                    total: total + (orderType === 'delivery' ? 10 : 0)
                },
                pagamento: {
                    metodo: 'A definir',
                    status: 'pendente'
                },
                observacoes: notes,
                origem: 'PAINEL_MANUAL',
                updatedAt: new Date().toISOString()
            };
            
            if (orderType === 'delivery') {
                orderData.entrega.endereco = deliveryAddress;
                orderData.cliente.endereco = deliveryAddress;
            }
            
            if (orderType === 'mesa') {
                orderData.mesa = tableNumber;
            }
            
            try {
                if (editingOrderId) {
                    // Atualizar pedido existente
                    await database.ref('online-orders/' + editingOrderId).update(orderData);
                    showToast('Pedido atualizado!', 'success');
                } else {
                    // Criar novo pedido
                    orderData.status = 'pending';
                    orderData.timestamp = new Date().toISOString();
                    orderData.timestampLegivel = new Date().toLocaleString('pt-BR');
                    var webId = 'WEB-' + Date.now() + '-' + generateId().toUpperCase();
                    
                    await database.ref('online-orders/' + webId).set(orderData);
                    showToast('Pedido criado!', 'success');
                }
                
                closeModal();
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showToast('Erro ao salvar pedido', 'error');
            }
        }
        
        function openStatusModal(orderId) {
            document.getElementById('status-order-id').value = orderId;
            document.getElementById('status-modal').classList.add('active');
        }
        
        function closeStatusModal() {
            document.getElementById('status-modal').classList.remove('active');
        }
        
        async function setStatus(status) {
            var orderId = document.getElementById('status-order-id').value;
            await quickStatus(orderId, status);
            closeStatusModal();
        }
        
        async function quickStatus(orderId, status) {
            try {
                await database.ref('online-orders/' + orderId).update({
                    status: status,
                    updatedAt: new Date().toISOString()
                });
                showToast('Status atualizado: ' + getStatusText(status), 'success');
                
                // Notifica√ß√£o PWA quando pedido ficar pronto
                var order = allOrders.find(function(o) { return o.id === orderId; });
                if (order && status === 'ready') {
                    notifyOrderReady(order);
                }
                
                // Oferecer envio de notifica√ß√£o WhatsApp
                if (order && ['confirmed', 'preparing', 'ready', 'delivered'].includes(status)) {
                    setTimeout(function() {
                        sendWhatsAppNotification(order, status);
                    }, 500);
                }
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao atualizar status', 'error');
            }
        }
        
        function sendWhatsAppNotification(order, newStatus) {
            var phone = (order.cliente && order.cliente.telefone) || (order.customer && order.customer.phone) || '';
            if (!phone) {
                console.log('Pedido sem telefone, nao e possivel enviar WhatsApp');
                return;
            }
            
            // Remover caracteres nao numericos
            phone = phone.replace(/\D/g, '');
            
            // Adicionar codigo do pais se nao tiver
            if (!phone.startsWith('55')) {
                phone = '55' + phone;
            }
            
            var orderNumber = order.number || order.numero || order.id.slice(-4);
            var customerName = (order.cliente && order.cliente.nome) || (order.customer && order.customer.name) || 'Cliente';
            
            // Buscar template do Firebase
            var template = messageTemplates[newStatus];
            
            if (!template) {
                console.warn('Template nao encontrado para status:', newStatus);
                template = 'Pedido #{numero} - Status atualizado';
            }
            
            // Substituir vari√°veis no template
            var message = template
                .replace(/\{nome\}/g, customerName)
                .replace(/\{numero\}/g, orderNumber)
                .replace(/\{status\}/g, getStatusText(newStatus));
            
            var encodedMessage = encodeURIComponent(message);
            var whatsappUrl = 'https://wa.me/' + phone + '?text=' + encodedMessage;
            
            // Perguntar se deseja enviar
            if (confirm('Enviar mensagem para ' + phone + '?\n\n"' + message + '"')) {
                window.open(whatsappUrl, '_blank');
            }
        }
        
        function refreshOrders() {
            showToast('Atualizando...', 'info');
            renderOrders();
        }
        
        async function forceReload() {
            showToast('Limpando cache...', 'info');
            
            try {
                // Verificar se est√° rodando via HTTPS (necess√°rio para PWA)
                if (window.location.protocol === 'file:') {
                    showToast('‚ö†Ô∏è Abra via servidor HTTPS para usar PWA', 'warning');
                    localStorage.clear();
                    sessionStorage.clear();
                    setTimeout(function() { window.location.reload(true); }, 1000);
                    return;
                }
                
                // Desregistrar Service Workers (apenas em HTTPS)
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                    }
                }
                
                // Limpar caches
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                // Limpar localStorage
                localStorage.clear();
                sessionStorage.clear();
                
                showToast('Cache limpo! Recarregando...', 'success');
                
                // Recarregar p√°gina
                setTimeout(function() {
                    window.location.reload(true);
                }, 1000);
            } catch (error) {
                console.warn('Aviso ao limpar cache:', error.message);
                // Limpar apenas storage se falhar
                localStorage.clear();
                sessionStorage.clear();
                showToast('Storage limpo! Recarregando...', 'info');
                setTimeout(function() { window.location.reload(true); }, 1000);
            }
        }
        
        // Modal para produto manual
        function openManualProductModal() {
            var name = prompt('Nome do produto:');
            if (!name) return;
            
            var priceStr = prompt('Preco (ex: 25.90):');
            if (!priceStr) return;
            
            var price = parseFloat(priceStr.replace(',', '.'));
            if (isNaN(price)) {
                showToast('Preco invalido', 'warning');
                return;
            }
            
            cartItems.push({
                id: 'manual_' + generateId(),
                name: name,
                price: price,
                quantity: 1
            });
            
            renderCart();
            showToast('Produto adicionado!', 'success');
        }
        
        // Excluir pedido
        async function deleteOrder(orderId) {
            if (!confirm('Tem certeza que deseja excluir este pedido?')) return;
            
            try {
                await database.ref('online-orders/' + orderId).remove();
                showToast('Pedido excluido!', 'success');
            } catch (error) {
                console.error('Erro:', error);
                showToast('Erro ao excluir pedido', 'error');
            }
        }
        
        async function deleteOrderFromModal() {
            var orderId = document.getElementById('status-order-id').value;
            closeStatusModal();
            await deleteOrder(orderId);
        }
        
        // ========================================
        // UTILIDADES
        // ========================================
        
        function getStatusText(status) {
            var map = {
                'pending': 'Pendente',
                'confirmed': 'Confirmado',
                'preparing': 'Preparando',
                'ready': 'Pronto',
                'delivered': 'Entregue',
                'cancelled': 'Cancelado'
            };
            return map[status] || status;
        }
        
        function getTimeAgo(dateString) {
            if (!dateString) return '--';
            
            var now = new Date();
            var date = new Date(dateString);
            
            // Validar se a data √© v√°lida
            if (isNaN(date.getTime())) {
                console.error('Data inv√°lida:', dateString);
                return '--';
            }
            
            var diff = now - date;
            
            // Se a data for do futuro (dessincroniza√ß√£o de rel√≥gio), usar valor absoluto
            if (diff < 0) {
                // Pequenas diferen√ßas (< 5 min) s√£o toleradas como dessincroniza√ß√£o
                if (Math.abs(diff) < 300000) { // 5 minutos em ms
                    diff = 0;
                } else {
                    // Diferen√ßas maiores: usar valor absoluto e marcar como futuro
                    diff = Math.abs(diff);
                }
            }
            
            var seconds = Math.floor(diff / 1000);
            var minutes = Math.floor(seconds / 60);
            var hours = Math.floor(minutes / 60);
            var days = Math.floor(hours / 24);
            
            if (days > 0) return 'h√° ' + days + 'd';
            if (hours > 0) return 'h√° ' + hours + 'h';
            if (minutes > 0) return 'h√° ' + minutes + 'min';
            if (seconds > 10) return 'h√° ' + seconds + 's';
            return 'Agora';
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function generateOrderNumber() {
            return Math.floor(1000 + Math.random() * 9000);
        }
        
        function updateConnectionStatus(online) {
            var dot = document.querySelector('.connection-dot');
            if (dot) {
                dot.className = 'connection-dot ' + (online ? 'online' : 'offline');
            }
        }
        
        function showToast(message, type) {
            type = type || 'info';
            var container = document.getElementById('toast-container');
            var toast = document.createElement('div');
            toast.className = 'toast ' + type;
            
            var icon = type === 'success' ? 'check-circle' : 
                       type === 'error' ? 'exclamation-circle' : 
                       type === 'warning' ? 'exclamation-triangle' : 'info-circle';
            
            toast.innerHTML = '<i class="fas fa-' + icon + '"></i> ' + message;
            container.appendChild(toast);
            
            setTimeout(function() {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
